# 챕터 11

## 이중화

인프라를 이중화 하는 이유는 특정 지점에 문제가 발생하더라도 이중화된 인프라르 통해 서비스 할 수 있기 때문이다. 그러면 서비스의 연속성이 보장되고 이것을 False Tolerance가 보장된다고 말한다.

이중화된 인프라를 구성할 때 특정 지점에 장애가 발생하여 인프라 용량이 절반으로 줄어들 수 있다는 것도 고려하여 용량을 산정해 설계해야 한다.

## LACP

Link Aggregation Control Protocol은 두 개 이상의 물리 인터페이스를 하나의 논리 인터페이스로 사용하게 해주는 프로토콜이다.

LACP를 구성할 때는 물리 인터페이스의 속도가 동일해야 한다. 그리고 액티브-액티브 형태로 구성 되기 때문에 한쪽이 장애가 발생하더라도 다른 한쪽만으로도 트래픽을 수용할 수 있게끔 구성해야 한다.

### 동작 방식

LACP를 구성하기 위해 LACP Data Unit이라는 프레임을 주고 받는다.

LACP에는 액티브 모드와 패시브 모드가 있다.

액티브는 먼저 LACPDU를 보내어 상대가 LACP 구성된 경우 연결하고, 패시브는 먼저 보내지는 않지만 수신하면 연결할 수 있다. 즉, 패시브 모드 끼리는 LACP 구성이 되지 않는다.

### PXE

PXE는 NIC가 부팅시 PXE 서버에 네트워크 할당을 요청하고, TFTP로 Network boot file을 다운로드 받아 OS를 자동으로 설치할 수 있도록 해주는 기술이다.

LACP와 PXE를 같이 사용하고자 할 때, OS가 설치되지 않아 처음에는 LACP 구성이 불가능하게 된다.

그래서 하나의 인터페이스만 먼저 활성화 시켜 통신한다. 그리고 OS 설치가 끝나 LACPDU를 보내기 시작하면 그 때 LACP 구성을 하는 것이다.

## MC-LAG

Multi-Chassis Link Aggregation Group 기술은 하나의 스위치가 장애로 서비스 불능이 되는 것을 막기 위해 **단일 MAC 주소를 사용**해 이중화 구성을 할 수 있도록 한다.

### 동작 방식

MC-LAG의 구성 요소를 살펴보면 다음과 같다.
- 피어 장비: MC-LAG을 구성하는 장비를 Peer 장비라고 한다.
- 도메인: 두 Peer 장비를 하나의 논리 장비로 구성하기 위한 영역 ID 이다.
- 피어 링크: 두 Peer 장비 간의 데이터 트래픽을 전송하는 인터링크이다.

피어 간 MC-LAG 구성을 마치면 다른 장비와 LACP 구성을 할 수 있게 된다.

### MC-LAG을 이용한 디자인

1. MC-LAG을 이용해 서버를 연결하면 물리적으로 스위치를 이중화 하면서 액티브-액티브 구성이 가능하다.
2. MC-LAG을 이용하여 루프 구조를 없앨 수 있다. -> STP에 의한 차단 포트 없이 모든 포트를 사용한다.
3. #1, #2를 MC-LAG으로, #3, #4를 MC-LAG으로 구성할 수도 있다.

## 게이트웨이 이중화

게이트웨이는 서브넷에 포함되지 않은 **외부 네트워크와 통신**하도록 해준다. 그러나 게이트웨이가 다운되면 정상적인 통신을 할 수 없게 된다.

LACP 구성과 유사하게 하나의 IP 주소와 MAC 주소를 가지게 하여 장애가 발생하더라도 통신이 가능하게 할 수 있다. 이때 사용하는 프로토콜이 First Hop Redundancy Protocol이다.

### FHRP

FHRP는 각 장비가 동일한 가상 IP와 MAC 주소를 가지도록 한다. 다른 호스트들이 ARP 요청을 보내면 액티브 상태의 장비가 ARP 요청에 응답한다. 만약 액티브 장비에 문제가 발생하면 스탠바이 장비가 이를 인식하여 액티브 역할을 가져온 뒤 통신이 그대로 이어진다.
