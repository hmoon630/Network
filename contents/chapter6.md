# 챕터 6

L4 장비는 TCP와 같은 L4 헤더를 이해하고 이 정보를 기반으로 작동한다. L4는 L2, L3와 다른 점을 이해해야 하는데, 세션 테이블과 그 안의 세션 정보가 가장 중요하다. 로드 밸런서, 방화벽 같은 장비를 '세션 장비'라고 부르기도 한다.

세션 장비의 특징으로 최우선으로 고려할 요소는 다음과 같다.
- 세션 테이블: 세션 정보를 저장, 확인한다. 세션 정보가 남아있는 시간은 한정적 이기 때문에 이를 고려해야 한다.
- Symmectric 경로 요구: Inbound와 Outbound 경로가 일치해야 한다.
- 정보 변경: IP 주소의 변경이나 L7 LB의 경우 애플리케이션 프로토콜 정보도 변경된다.

## 로드 밸런서

로드 밸런서는 서버나 장비의 부하를 분산하기 위해 사용한다.

LB 뒤의 작은 시스템 여러 대 일지라도 하나의 서비스로서 보여야 하기 때문에 대표 IP 주소를 서비스 IP로 가지고 그 밑에 있는 시스템은 LB가 실제 IP로 변경하여 요청을 보낸다.

LB는 웹, 앱, FWLB(FireWall Load Balancing), VPNLB와 같은 서비스를 위해 사용한다.

## 방화벽

네트워크 중간에 해당 장비를 통과하는 트래픽을 정책 조건에 맞추어 허용, 차단하는 장비를 방화벽이라 부른다. 

방화벽은 NAT 방식과 유사하게 세션 정보를 세션 테이블에 저장한다. 패킷이 외부로 나가거나 내부로 들어올 때 어디에서 처음 시작된 것인지를 가려낸다. 세션 테이블을 이용해 패킷의 인과관계를 파악할 수 있어 정책을 간단히 한다.

## 세션 관리

세션 장비는 세션 테이블을 이용해 패킷을 포워드하거나 드랍할 수 있다. 이 기능을 활용하려면 여러 세션 장비간 세션 정보를 동일하게 유지하거나 대칭 경로를 지나도록 고려해야 한다.

### 세션 테이블 유지

세션 정보는 효율적인 메모리 사용과 세션 악용을 방지하기 위해 일정 시간만 세션 테이블에 유지한다.

하지만 일부 애플리케이션은 세션 타임아웃 값을 더 길게 설정하여 세션 장비에서만 정보가 사라지는 일이 발생할 수 있다. 이 경우 중간에서 통신이 막힌다. 이를 해결하려면 다음의 방법들이 있다.

세션 장비 운영자 입장
- 세션 만료 시간을 증가시킨다.
- 세션 타임아웃 시 양 단말에 종료를 통보한다.

개발자 입장
- 애플리케이션에서 주기적인 패킷 발생 기능 추가

### 비대칭 경로 문제

HA를 위해 세션 장비를 이중화 하면 인바운드와 아웃바운드의 경로가 다를 수 있다. 그러면 정상적인 서비스가 되지 않을 수 있다.

이를 해결하는 방법으로 세션을 동기화 하는 방법이 있다. 그러면 하나의 테이블을 공유하기 때문에 비대칭 경로에도 정상적으로 동작한다. 하지만 패킷 응답 시간이 세션 동기화 하는 시간보다 빠르면 정상 동작하지 않는다는 단점이 있다.

두 번째 방법으로 세션 장비에서 다른 쪽 장비로 패킷을 보내어 경로를 보정하는 방법이 있다. 그러면 방화벽 간 통신 링크가 필요하고 MAC 리라이팅이나 MAC 주소를 한번 더 캡슐화하는 터널링 기법으로 경로를 보정한다.
