# 챕터 7

## NAT

### SNAT

SNAT는 사설에서 공인으로 통신할 때 많이 사용한다. 응답을 받기 위해서 Public IP가 필요한데 Private IP를 Public으로 바꾸어야 한다. 그래야 목적지에서 다시 응답을 줄 수 있다. 이는 PAT를 사용하는 경우에 해당한다.

또 다른 이유는 보안상 사용할 때 이다. 회사에서 대외사와 통신 시 내부 IP 체계를 보여주지 않기 위해 사용한다. 이는 꼭 Public IP일 필요가 없다. 혹은 IP 주소 체계가 겹칠 경우 다른 IP로 변경하기도 한다.

### DNAT

DNAT는 로드 밸런서에서 많이 사용한다. 사용자는 로드 밸런서에 설정된 서비스 VIP(Virtual IP)로 요청하고 로드 밸런서는 실제 서버의 IP로 DNAT해 내보낸다.

### 동적/정적 NAT

동적 NAT는 NAT를 수행하는 시점에 IP 풀에서 어떤 IP로 매핑할 건지 판단한다. 따라서 NAT를 수행하는 시점에 NAT 테이블이 생성된다. 이 테이블은 타임아웃이 있기 때문에 잠깐 동안 사용할 때 사용할 수 있다.

정적 NAT는 출발지와 목적지 매핑 관계가 사전에 정의 되어 있다. 그래서 1:1 NAT라고 불리기도 한다.

## DNS

### 마스터와 슬레이브

DNS 서버는 마스터 서버와 슬레이브 서버로 나뉜다. 두 서버의 우선순위 차이는 없고, 마스터는 도메인에 대한 Zone 파일을 직접 관리한다. 슬레이브는 마스터에서 Zone 파일을 정기적으로 복제한다.

이 복제를 영역 전송이라고 하는데, 이 영역 전송을 허용할 슬레이브를 정하지 않으면 무제한 복제가 가능해진다. 

DNS는 이중화에서 액티브-스탠바이, 액티브-액티브 형태로 구성하지 않는다. 마스터 서버에 문제가 생기면 슬레이브는 만료 시간(Expiry Time)이 지나면 마스터에서 Zone 정보를 받아오지 못한다. 따라서 만료 시간 내에 마스터를 복구하거나 슬레이브를 마스터로 전환해야 한다.

### 도메인 위임

서브 도메인을 다른 곳으로 위임하여 관리 주체를 분리할 수 있다. CDN을 이용하거나 GSLB를 이용하는 것이 대표적인 경우이다.

### 화이트 도메인

KISA에서는 스팸메일 차단활동을 하고 있다. 이를 위해 정상적인 도메인을 인증, 관리하는 것을 **화이트 도메인**이라고 부르고, 블랙 리스트를 **RBL(Realtime Blocking List)** 라고 한다.

## GSLB

Global Service Load Balancer는 DNS와 동일하게 도메인 질의에 응답하는 동시에 로드 밸런서처럼 헬스 체크도 수행한다. 서버에서 장애가 감지되면 해당 레코드는 응답으로 사용되지 않는다.

## DHCP

**Dynamic Host Configuration Protocol**은 호스트에 IP 정보를 동적으로 할당해주는 프로토콜이다. IP, Subnet Mask, Gateway, DNS 정보 등을 자동으로 할당해준다.

DHCP는 BOOTP(Bootstrap Protocol)라는 프로토콜을 기반으로 한다. DHCP가 BOOTP의 확장 프로토콜이기에 호환성이 있고, 사용하는 포트도 68(bootpc), 67(bootps)로 같다.

### DHCP 할당 과정

1. DHCP Discover
   - DHCP 클라이언트는 DHCP 서버를 찾기 위해 DHCP Discover 메시지를 브로드캐스트한다.
2. DHCP Offer
   - DHCP Discover를 수신한 DHCP 서버가 IP 할당 정보를 포함한 DHCP 메시지를 클라이언트로 전송한다.
3. DHCP Request
   - DHCP 서버로부터 제안받은 IP 주소와 서버 정보를 포함한 DHCP 요청 메시지를 브로드캐스트한다.
4. DHCP Acknowledgement
   - DHCP 클라이언트에서 요청을 받으면 서버는 언제부터 IP를 사용하는지 기록하고 Ack 메시지를 보낸다.

- 할당 과정에서는 패킷을 정상적으로 주고받을 수 없어 TCP가 아닌 UDP를 사용한다.
- 설정이 없으면 IP Pool에서 임의 할당하지만, MAC 주소와 IP 주소를 사전에 정의하여 고정 IP 할당도 가능하다.
- DHCP Request 할 때에도 Broadcast를 사용하는 이유는 여러 대의 DHCP 서버가 존재할 수도 있기 때문이다.
- 이 모든 과정을 임대(Lease) 과정이라고 한다. 즉, 임대 시간이 존재한다.
- 임대 시간이 지나면 IP를 재할당 받아야 하는데, 실제로는 임대 시간의 50%가 지나면 **갱신** 과정을 거친다.

## DHCP 릴레이

DHCP 서버에서 IP 주소를 할당받기 위해 클라이언트는 브로드캐스트를 한다. 브로드캐스트는 동일 네트워크에만 전송되므로 여러 개의 네트워크가 있다면 각각 DHCP 서버가 필요할 수 있다.

하지만 **DHCP 릴레이 에이전트(Relay Agent)** 기능을 사용하면 하나의 DHCP 서버로 여러 네트워크 대역에서 IP 풀을 관리할 수 있다.

릴레이 에이전트를 통해 IP를 할당받더라도 과정은 크게 달라지지 않는다. 다만 IP를 변환하고 패킷을 전달해주는 과정이 추가된 것 뿐이다.
