# 챕터 12

## 로드 밸런서

### 로드 밸런서 동작 모드

- 트랜스패런트 모드
  - LB가 L2 스위치처럼 동작하는 구성이다. 즉 서비스할 때 사용하는 VIP와 실제 서버가 **동일한 네트워크**를 사용하는 구성이다. 
- Routed 모드
  - routed 모드는 서버 네트워크를 사설로 구성해 서버에 직접 접속하지 못할 때 사용된다. 로드밸런서 기준으로 클라이언트 쪽과 서버 쪽이 서로 다른 네트워크인 경우이다.
- Direct Server Return 모드
  - 서버 응답이 로드 밸런서를 거치지 않고 바로 클라이언트에게 전달되는 방식이다.
  - 그러나 DSR은 응답 시 로드 밸런서를 거치지 않아야 하기 때문에 SNAT를 수행하지 않는다.
  - 그리고 서버에서는 루프백 인터페이스를 생성하여 VIP 그대로 수신할 수 있도록 한다.
  - 또한 GARP를 보내거나 ARP 응답을 하지 않도록 해야한다.

## 로드 밸런서 유의 사항

### 원암 구성의 동일 네트워크 사용 시

원암 구성에서 사용자 > VIP(10.10)로 요청시 로드 밸런서에서 DNAT를 거쳐 실제 서버 IP(10.11)로 전달된다. 실제 서버에서 응답할 때에는 L3 스위치를 통해 응답하는데, 이 때 실제 서버(10.11)에서 응답하게 된다. 그러면 사용자는 실제 호출하지 않은 IP로부터 받은 응답 패킷을 정상적으로 처리하지 않게 된다.

해결 방법
- 게이트웨이를 로드 밸런서로 설정: 이 경우 원암 구조의 장점인 로드 밸런서 부하 감소효과가 줄어들 수 있다.
- SNAT 사용: 로드 밸런서를 거칠 때 Source IP를 NAT 하는 방법이 있다. 다만 서버 애플리케이션에서 서비스를 호출한 IP가 하나의 동일한 IP로 보일 수 있기에 HTTP의 헤더인 X-Forwarded-For(XFF)를 사용해 실제 사용자 IP를 확인할 수 있다.
- DSR 모드: 별도의 DNAT를 수행하지 않고 실제 서버에 VIP 정보를 루프백 인터페이스에 설정하여 바로 로드밸런서를 거치지 않고 응답하도록 한다.

### 동일 네트워크 내에서 VIP 호출 시

위의 해결 방법과 동일하다.
