# 챕터 4

## 스위치

스위치는 패킷을 동시에 여러 장비가 서로 간섭 없이 통신하도록 도와주는 장비이다.

스위치의 핵심 역할은 장비들의 위치를 파악하고 실제 통신이 시작되면 해당 위치로 패킷을 정확히 전송하는 것이다. 이는 단말의 주소인 MAC 주소와 단말이 위치한 인터페이스 정보를 매핑한 **MAC 주소 테이블**을 갖고 있기 때문이다.

스위치의 동작 방식은 3가지로 정리할 수 있다.

### 플러딩

스위치는 부팅 시 정보를 아무 것도 가지고 있지 않다. 이때는 허브처럼 동작하게 된다. 허브는 패킷이 들어온 포트를 제외하고 모든 포트로 패킷을 전달한다. 이러한 동작 방식을 플러딩이라고 한다.

스위치는 LAN에서 동작하므로 패킷의 MAC 주소가 자신의 테이블에 없더라도 어딘가에 장비가 있을 수 있다고 가정하고 이러한 작업을 수행한다.

TCP/IP 네트워크에서 스위치가 유니캐스트를 플러딩하는 경우는 거의 없다. ARP 브로드캐스트가 먼저 수행되어 스위치는 MAC 테이블에 기록할 것이고, 그러면 Unknown Unicast는 발생하지 않게 된다.

### 어드레스 러닝

스위치가 패킷의 도착지 MAC 주소를 확인하여 포워딩하는 동작을 정상적으로 수행하려면 MAC 주소 테이블을 만들고 유지해야 한다.

패킷이 스위치로 들어오면 출발지 MAC 주소 정보를 이용하여 MAC 주소 테이블을 만든다. 어드레스 러닝은 출발지의 MAC 주소를 사용하기에 브로드캐스트나 멀티캐스트에 대한 MAC 주소를 학습할 수 없다.

### 포워딩/필터링

스위치에 패킷이 들어온 경우 도착지 MAC 주소를 확인하여 해당 MAC 주소를 가진 장비로 연결된 포트로 패킷을 포워딩한다. 이때 다른 포트로는 보내지 않으므로 이 동작을 필터링이라고 한다.

## VLAN

VLAN은 물리적 배치와 상관 없이 LAN을 논리적으로 분할, 구성하는 기술이다.

스위치를 논리적으로 분할해 사용하는 것이 목적인 VLAN을 **포트 기반 VLAN(Port Based VLAN)** 이라고 부른다. VLAN이라고 부르는 것은 대부분 이를 뜻한다. 포트 기반 VLAN은 스위치의 포트 위치에 따라 VLAN이 결정된다.

사용자들의 자리 이동이 많아지면서 MAC 기반의 VLAN도 개발되었다. 포트 위치에 VLAN을 부여하는 것이 아닌, 단말의 MAC 주소를 기반으로 VLAN을 할당하는 것이다.

### VLAN 모드(Trunk/Access) 동작 방식

여러 개의 VLAN이 존재하는 상황에서 서로 다른 스위치를 연결하는 경우 VLAN 끼리 통신하기 위해서 VLAN 개수만큼 포트를 연결해야 한다. 하지만 VLAN의 갯수가 많아질 수록 포트가 낭비된다.

이런 스위치간의 연결을 지원하기 위해 VLAN 태그 기능이 있다. 하나의 포트로 여러 개의 VLAN을 전송할 수 있다. 이 포트를 **태그(Tagged) 포트** 또는 **트렁크(Trunk) 포트**라고 한다.

태그 포트는 통신할 때 이더넷 프레임 중간에 VLAN ID 필드를 끼워 넣어 이 정보를 이용한다. 태그 포트로 보낼 때는 VLAN ID를 붙이고 받을 때는 VLAN ID를 제거한다.

스위치의 MAC 테이블에도 변화가 생긴다. VLAN 끼리 통신하지 못하도록 MAC 테이블에 VLAN을 지정하는 필드가 추가된다.

스위치간의 연결이 아닌 서버와 연결할 때도 VMware의 ESXi와 같은 가상화 서버가 연결될 때는 여러 VLAN과 통신해야할 수 있다. 이 때에도 태그 포트로 연결하여야 한다.

## 네트워크 루프

IT 환경에서는 SPoF(Single Point of Failure: 단일 장애점)으로 인한 장애를 피하기 위해 이중화, 다중화된 네트워크를 구성한다.

SPoF를 피하기 위해 스위치 두 대로 네트워크를 디자인 하면 스위치 간 패킷이 계속 전송되는 **네트워크 루프(Loop)** 가 발생한다.

### 브로드캐스트 스톰

루프 구조로 된 네트워크에서 브로드캐스트를 발생시키면 패킷이 유입된 포트를 제외한 모든 포트로 플러딩 한다. 루프 구조 상태에서는 이 패킷이 계속 돌아가는데, 이는 2계층 헤더에는 TTL이 없어 패킷이 죽지 않는다.

브로드캐스트 스톰이 발생하면 다음과 같은 일이 벌어진다.
1. 브로드캐스트를 처리하느라 CPU 자원을 많이 사용한다 -> 단말의 속도가 느려진다.
2. 네트워크 접속 속도가 느려진다.
3. 네트워크에 설치된 스위치에 모든 LED들이 동시에 빠른 속도로 깜빡인다.

### 스위치 MAC 러닝 중복

루프 구조 상태에서는 유니캐스트도 문제를 일으킨다. 같은 패킷이 루프를 돌아 도착지에서 중복 수신되기도 하지만, 중간 스위치도 MAC 주소를 정상적으로 학습할 수 없다. 이 현상을 **MAC 어드레스 플래핑(MAC Address Flapping)** 이라고 한다.

이렇게 루프가 발생할 경우 네트워크에 조치를 취해야 한다.

루프 중 포트 하나를 셧다운해도 루프를 예방할 수 있다. 하지만 이는 SPoF를 예방하기 위해 디자인 한 것을 사용하지 못하게 하였으므로 바람직하지 않다.

이런 이유로 루프를 자동 감지해 포트를 차단하고 장애 때문에 우회로가 없을 때 차단된 포트를 다시 풀어주는 STP가 개발 되었다.

## STP

**STP(Spanning Tree Protocol)** 는 루프를 확인하고 적절히 포트를 사용하지 못하게 하여 루프를 예방하는 메커니즘이다.

스위치 간의 연결을 확인하기 위해 **BPDU(Bridge Protocol Data Unit)** 이라는 프로토콜을 통해 스위치간 정보를 교환한다. BPDU에는 스위치의 ID와 같은 고유 값이 들어가고 이러한 정보들로 스위치의 상호 정보와 토폴로지를 파악할 수 있다.

### 스위치 포트 상태

루프를 막기 위해 포트에 신규 스위치가 연결되면 바로 트래픽이 흐르지 않게 차단한다. BPDU를 기다려 학습하고 구조를 파악한 후 포트를 개방할지 결정한다.

차단 상태에서 트래픽이 흐를 때 까지 4단계의 상태 변화를 거친다.

1. Blocking
   - 패킷을 차단한 상태로 BPDU를 기다린다.
   - Max Age 기간(20초) 동안 BPDU를 받지 못하거나 후순위 BPDU를 받으면 Listening 상태로 변경된다.
   - BPDU의 교환 주기는 2초이고, 10번을 기다린다.

2. Listening
   - 리스닝 상태는 포트를 Forwarding 상태로 변경하는 것을 결정하고 준비하는 단계이다. 이때부터 자신의 BPDU 정보를 상대에게 전달한다.
   - 총 15초간 대기한다.

3. Learning
   - Forwarding 으로 변경하기를 결정하고 스위치가 곧바로 동작하도록 MAC 주소를 학습하는 단계이다.

4. Forwarding
   - 패킷을 포워딩 하는 단계이다. 정상적인 통신이 가능하다.

이 과정에서 50여 초가 소요된다. 스위치가 루프를 방지하기 위해 매우 방어적으로 동작하기 때문이다.

만약 특정 링크가 다운된다면 위의 과정을 다시 거치게 된다. 하지만 자신의 인터페이스가 다운된 걸 감지한 경우 Blocking 단계를 스킵하고 Listening 과정부터 거친다.

### STP 동작 방식

STP는 이름에서 알 수 있듯이 트리 구조와 같은 양상을 띈다. 네트워크 상에서 **루트 스위치**를 선출하고 이 스위치를 통해 BPDU가 교환되도록 한다.

처음에는 모든 스위치가 자신을 루트 스위치로 인식한다. BPDU를 통해 2초마다 자신이 루트임을 광고하고, 새로운 스위치가 들어오면 브릿지 ID를 비교해 더 작은 ID 값을 가진 스위치를 루트 스위치로 선정한다.

STP는 다음과 같이 동작한다.

1. 하나의 루트 스위치를 선정한다.
   - 전체 네트워크에 하나의 루트 스위치만 존재한다.
2. 루트가 아닌 스위치 중 하나의 루트 포트를 선정한다.
   - 루트 브릿지로 가는 가장 경로가 짧은 포트를 루트 포트라고 한다.
   - 루트 브릿지에서 보낸 BPDU를 수신하는 포트다.
3. 하나의 세그멘트에 하나의 지정 포트를 선정한다.
   - 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정한다.
   - 루트 포트가 이미 있는 경우 반대쪽이 지정 포트로 선정되어 양쪽 모두 포워딩 상태가 된다.
   - 루트 포트가 없을 경우 한쪽은 지정 포트로 선정되고 한쪽은 대체 포트가 되어 차단 상태가 된다.
   - BPDU를 전달하는 포트이다.

### Port Fast

STP의 방어적인 동작은 시간 지연을 일으킬 수 있다. 일반 PC와 연결하고자 하는 경우 포트를 Port Fast로 설정하면 BPDU 대기, 습득 없이 바로 포워딩으로 사용할 수 있다.

그러나 이는 스위치가 접속할 수 있기에, BPDU가 들어오자마자 차단하는 BPDU Guard가 함께 사용되어야 한다.

## 향상된 STP

STP는 루프를 예방하기 위해 Blocking 포트가 Forwarding 포트가 될 때 까지 30~50초가 소요된다. TCP 기반 애플리케이션은 네트워크가 끊겼을 때 이 시간을 기다릴 수 없어 통신이 끊길 수 있다. 또한 스위치에 VLAN이 여러개 있으면 이를 계산하면서 부하가 발생하기도 한다.

### RSTP

Rapid STP는 2~3 초로 전환 시간을 줄여 TCP 기반 애플리케이션이 세션을 유지할수 있게 한다.

기본 동작 방식은 STP와 같지만, BPDU 플래그의 메시지가 다양해져 여러 상태를 교환할 수 있다.

|Bit    |Flag       |
|-------|-----------|
|0      |Topology Change(TC)    |
|1      |Proposal               |
|2,3    |00: Unkown, 01: 대체 포트, 10: 루트 포트, 11: 지정 포트|
|4      |Learning               |
|5      |Forwarding             |
|6      |Agreement              |
|7      |Topology Change Acknowledgement(TCA)   |

기존 STP는 토폴로지가 변경되면 루트 브릿지까지 변경을 보고하고 그에대한 연산을 한 후 통보하는 과정을 거쳤지만, RSTP는 변경이 일어난 스위치 자신이 모든 네트워크에 토폴로지 변경을 직접 전파할 수 있다.

그 덕에 더 빠른 시간에 토폴로지 변경을 감지하고 복구할 수 있게 되었다.

### MST

STP는 CST(Common Spanning Tree)라고 불린다. VLAN 개수와 상관없이 ST 하나만 동작하는데, 이는 관리부하가 적은 대신 VLAN 마다 최적의 경로를 고려하지 못해 멀리 돌아 통신해야 할 수 있다.

이를 해결하기 위해 PVST(Per VLAN Spanning Tree)가 개발되어 VLAN 마다 ST를 만들 수 있게 되었다.

하지만 STP는 2초마다 BPDU를 주고 받아 부하가 발생하는데 VLAN 마다 ST를 유지하니 더 큰 부담이 되었다. 이 단점들을 보완하기 위해 MST(Multiple Spanning Tree)가 개발되었다.

여러 개의 VLAN을 그룹으로 묶어 그룹마다 ST를 가지도록 한다. 그러면 PVST보다 더 적은 STP가 돌아 부하가 줄어들도록 하였다.
